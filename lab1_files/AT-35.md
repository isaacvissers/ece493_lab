# Acceptance Test Suite — UC-35 Store Payment Confirmation and Record Registration Status

## Scope
Validate that the system reliably stores payment confirmations and updates registration status, ensuring financial and registration integrity. Specifically, CMS must:
- accept only trusted/valid payment confirmations,
- match confirmations to existing orders/registrations,
- store confirmation details durably,
- update registration/order status to **Paid/Confirmed** only after persistence,
- enforce idempotency for duplicate confirmations,
- handle database and audit logging failures safely,
- tolerate downstream failures (ticket generation/notifications) without corrupting core state.

Covers UC-35 extensions (2a, 2b, 3a, 4a, 5a, 6a, 8a).

## Assumptions / Notes
- Payment confirmations may arrive synchronously (checkout redirect) or asynchronously (webhook). Tests apply to either mechanism.
- The system has an order/registration record that includes expected amount/currency and a payment intent/transaction identifier.
- “Trusted source” means the event passes gateway signature/verification checks (where applicable).
- System must not mark registration as confirmed unless confirmation is durably stored (or explicitly supports a **Pending confirmation** state).

---

## Test Data
- Users:
  - **Attendee**: `attendee1@example.com`
- Conferences:
  - `CONF-20` paid registration enabled
- Orders/registrations:
  - `ORDER-9001` for `CONF-20`, expected amount $250 CAD, status **Unpaid**
  - `ORDER-9002` for `CONF-20`, expected amount $100 CAD, status **Unpaid**
- Payment confirmations (fixtures):
  - Valid confirmation for `ORDER-9001`: transaction `TXN-AAA111`, amount $250 CAD, signature valid
  - Invalid signature confirmation for `ORDER-9001`: transaction `TXN-BAD999`, signature invalid
  - Wrong amount confirmation for `ORDER-9002`: transaction `TXN-AMT777`, amount $999 CAD, signature valid
  - Unknown order confirmation: transaction `TXN-UNK555`, references `ORDER-DOESNOTEXIST`, signature valid
  - Duplicate confirmation: resend `TXN-AAA111`
- Failure simulations:
  - DB write failure when saving payment record
  - DB failure when updating order status
  - Audit logging service failure
  - Downstream ticket generation/notification failure

---

# Test Cases

## AT-UC35-01 — Valid payment confirmation is stored and order status becomes Paid/Confirmed (Happy Path)
**Objective:** Ensure success path persists payment and updates status.  
**Preconditions:** `ORDER-9001` exists and is **Unpaid**; system can receive confirmation events.  
**Steps:**
1. Deliver a valid payment confirmation event for `ORDER-9001` (TXN-AAA111, $250 CAD, valid signature).
2. Query order/registration status in CMS (admin view or API).
3. Query stored payment record linked to the order.
**Expected Results:**
- Payment confirmation record is stored with correct transaction ID, amount/currency, timestamp, and linkage to `ORDER-9001`.
- Order/registration status updates to **Paid/Confirmed**.
- Audit log entry exists for confirmation processing (if audit view exists).

---

## AT-UC35-02 — Confirmation with invalid signature/source is rejected; no status update (Extension 2a: invalid signature)
**Objective:** Ensure only trusted events are accepted.  
**Preconditions:** `ORDER-9001` is **Unpaid**.  
**Steps:**
1. Deliver a confirmation event with invalid signature (TXN-BAD999).
2. Check order status and payment records.
**Expected Results:**
- Event is rejected.
- No payment record stored for TXN-BAD999.
- `ORDER-9001` remains **Unpaid**.
- Security/validation failure is logged.

---

## AT-UC35-03 — Confirmation with wrong amount/currency is rejected; no status update (Extension 2a: wrong amount/currency)
**Objective:** Ensure amount/currency validation prevents mismatched confirmations.  
**Preconditions:** `ORDER-9002` expected $100 CAD, **Unpaid**.  
**Steps:**
1. Deliver validly signed confirmation with wrong amount (TXN-AMT777, $999 CAD).
2. Check order status and payment records.
**Expected Results:**
- Confirmation fails validation and is not applied.
- No successful payment record stored (or stored in a rejected/error table per design, but not as successful).
- `ORDER-9002` remains **Unpaid**.
- Validation failure logged for investigation.

---

## AT-UC35-04 — No matching order: confirmation routed to unmatched queue/store; no status update (Extension 2b)
**Objective:** Ensure orphan confirmations don’t confirm unknown registrations.  
**Preconditions:** No order exists for `ORDER-DOESNOTEXIST`.  
**Steps:**
1. Deliver validly signed confirmation referencing unknown order (TXN-UNK555).
2. Inspect unmatched payments queue/store (admin view) and check for any status changes.
**Expected Results:**
- Event is stored/queued as **Unmatched** (or equivalent) for reconciliation.
- No registration/order is marked **Paid/Confirmed**.
- Mismatch is logged and optionally alerts admins.

---

## AT-UC35-05 — Duplicate confirmation is idempotently ignored; no duplicate records (Extension 3a)
**Objective:** Ensure webhook retries do not create duplicates.  
**Preconditions:** AT-UC35-01 completed (TXN-AAA111 already processed).  
**Steps:**
1. Deliver the same confirmation event again (TXN-AAA111).
2. Inspect payment records and order status.
**Expected Results:**
- No duplicate payment confirmation records are created for TXN-AAA111.
- Order remains **Paid/Confirmed** (no repeated side effects).
- System returns/records successful acknowledgement for the duplicate event.
- Duplicate detection may be logged as informational.

---

## AT-UC35-06 — DB failure saving payment record prevents confirming registration (Extension 4a)
**Objective:** Ensure confirmation requires durable persistence.  
**Preconditions:** `ORDER-9001` reset to **Unpaid**; simulate DB write failure on payment insert.  
**Steps:**
1. Deliver valid confirmation (TXN-AAA111) while DB write failure is active.
2. Check order status and payment record presence.
**Expected Results:**
- Payment record is not stored.
- Order/registration is not marked **Paid/Confirmed** (remains **Unpaid** or becomes **Pending confirmation** if supported, but not confirmed).
- Failure is logged and order flagged for reconciliation/retry.

---

## AT-UC35-07 — Payment stored but status update fails; system retries/flags for reconciliation (Extension 5a)
**Objective:** Ensure system handles partial failure safely and restores consistency.  
**Preconditions:** Simulate failure when updating order status; allow payment insert to succeed.  
**Steps:**
1. Deliver valid confirmation (TXN-AAA111).
2. Verify payment record exists.
3. Verify order status did not update due to simulated failure.
4. Restore system and trigger retry mechanism (background job/manual retry) if available.
**Expected Results:**
- Payment record is stored successfully.
- Initial order status update fails and is logged/flagged.
- System retries or reconciliation mechanism updates order status to **Paid/Confirmed** eventually.
- No duplicate payment record is created during retries.

---

## AT-UC35-08 — Audit logging failure does not prevent storing payment + confirming status (Extension 6a)
**Objective:** Ensure audit failures don’t block core financial state.  
**Preconditions:** Simulate audit logging outage; DB is healthy.  
**Steps:**
1. Deliver valid confirmation for an unpaid order.
2. Verify payment record and order status.
3. Verify audit log entry behavior (missing/queued) if observable.
**Expected Results:**
- Payment record stored and order status becomes **Paid/Confirmed**.
- Audit log write fails but is queued/fallback logged if supported.
- Audit failure is recorded for later repair.

---

## AT-UC35-09 — Downstream failures do not roll back payment/status (Extension 8a)
**Objective:** Ensure ticket generation/notification failures don’t corrupt registration status.  
**Preconditions:** Configure downstream ticket generation or notifications to fail; core DB is healthy.  
**Steps:**
1. Deliver valid payment confirmation for an unpaid order.
2. Trigger downstream actions (ticket generation, email) as part of the workflow.
3. Check stored payment + registration status.
**Expected Results:**
- Payment confirmation remains stored.
- Registration/order remains **Paid/Confirmed**.
- Downstream failures are logged and may be retried; no rollback of core state occurs.

---

# Exit Criteria (Definition of Done for UC-35)
UC-35 is accepted when:
- Valid confirmations are persisted and statuses updated correctly (AT-UC35-01), and
- Invalid/unsafe confirmations are rejected and do not change registration state (AT-UC35-02, AT-UC35-03), and
- Unmatched confirmations are safely queued for reconciliation (AT-UC35-04), and
- Idempotency prevents duplicates (AT-UC35-05), and
- Persistence and status-update failures are handled without false confirmations (AT-UC35-06, AT-UC35-07), and
- Audit and downstream failures do not corrupt core payment/registration state (AT-UC35-08, AT-UC35-09).
