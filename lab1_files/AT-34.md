# Acceptance Test Suite — UC-34 Receive Payment Confirmation (Ticket)

## Scope
Validate that after successful registration payment, an attendee receives and can later access a payment confirmation (ticket/receipt) as proof of registration, and that CMS:
- generates a confirmation artifact after successful payment (or $0 confirmation),
- displays confirmation immediately post-payment,
- stores and links the ticket/receipt to the attendee account,
- delivers confirmation via email/in-app when configured,
- does not generate confirmations when payment fails,
- handles generation, storage, notification, auth, and duplicate-request scenarios safely.

Covers UC-34 extensions (1a, 3a, 5a, 6a, 7a, 7b).

## Assumptions / Notes
- Ticket/receipt format may be HTML, PDF, or both; tests validate user-visible behavior.
- Payment completion is performed by UC-33 (credit card) or a free-ticket workflow; UC-34 begins once payment/confirmation exists.
- System should not create duplicate tickets for a single transaction.

---

## Test Data
- Users:
  - **Attendee**: `attendee1@example.com`
- Conferences:
  - `CONF-18` paid registration enabled
  - `CONF-19` free registration enabled ($0)
- Ticket types:
  - `TICKET-PAID`: $250
  - `TICKET-FREE`: $0
- Payment methods (gateway test fixtures):
  - Approved payment
  - Declined payment
- Failure simulations:
  - Ticket/receipt renderer failure (template/PDF failure)
  - Storage/DB failure when saving ticket
  - Notification failure (email/in-app)
- Confirmation artifacts expected fields (minimum):
  - Conference name/ID
  - Attendee name
  - Ticket type
  - Amount paid
  - Transaction reference / receipt number
  - Date/time of purchase

---

# Test Cases

## AT-UC34-01 — After successful payment, confirmation page shows ticket/receipt details (Happy Path)
**Objective:** Ensure immediate confirmation is displayed post-payment.  
**Preconditions:** `CONF-18` checkout; attendee logged in; payment approved and recorded.  
**Steps:**
1. Complete paid registration payment (UC-33 success) for `CONF-18`.
2. Observe post-payment confirmation page.
**Expected Results:**
- Confirmation page is displayed.
- Ticket/receipt summary includes required fields (conference, attendee, ticket, amount, transaction ref, timestamp).
- Download/print option is available if supported.

---

## AT-UC34-02 — Ticket/receipt is stored and accessible later in account
**Objective:** Ensure durable access as proof of registration.  
**Preconditions:** AT-UC34-01 completed.  
**Steps:**
1. Log out and log back in as `attendee1@example.com`.
2. Navigate to **My Registration / Tickets**.
3. Open the ticket/receipt for `CONF-18`.
**Expected Results:**
- Ticket/receipt is available and opens successfully.
- Content matches the successful purchase and includes transaction reference.
- Registration status remains **Paid/Confirmed**.

---

## AT-UC34-03 — Confirmation notification delivered via email/in-app (If applicable)
**Objective:** Validate confirmation delivery.  
**Preconditions:** Notifications enabled; successful payment recorded.  
**Steps:**
1. Complete paid registration successfully.
2. Check email inbox (test mailbox) and/or in-app notifications.
**Expected Results:**
- Confirmation message delivered.
- Contains ticket/receipt attachment or link to ticket page.
- No sensitive card data is included (e.g., full PAN, CVV).

---

## AT-UC34-04 — Payment not completed: no ticket generated and status not confirmed (Extension 1a)
**Objective:** Ensure failed payment does not generate proof of registration.  
**Preconditions:** `CONF-18` checkout; declined payment scenario.  
**Steps:**
1. Attempt payment with declined test method.
2. Navigate to **My Registration / Tickets**.
**Expected Results:**
- No ticket/receipt is generated for the failed transaction.
- Registration remains unpaid/unconfirmed (or “payment failed”).
- User sees clear payment failure feedback.

---

## AT-UC34-05 — Ticket/receipt generation fails: user informed; payment remains confirmed (Extension 3a)
**Objective:** Ensure generator failure doesn’t lose a successful payment.  
**Preconditions:** Simulate ticket/receipt renderer failure after successful payment record exists.  
**Steps:**
1. Complete successful payment (gateway approves).
2. Trigger ticket generation failure.
3. Check user-facing confirmation state.
**Expected Results:**
- User sees message that confirmation is pending/could not be generated.
- Registration remains **Paid/Confirmed** (payment record exists).
- System logs the generation failure and may retry.
- Ticket becomes available once generation is restored (manual or auto).

---

## AT-UC34-06 — Storage/DB failure saving ticket: user informed; payment remains confirmed (Extension 5a)
**Objective:** Ensure persistence failures are handled with reconciliation safeguards.  
**Preconditions:** Simulate DB/storage failure when saving ticket after payment success.  
**Steps:**
1. Complete successful payment.
2. Trigger storage failure at ticket save step.
3. Navigate to account tickets page.
**Expected Results:**
- User sees error indicating ticket could not be saved/available yet.
- Payment remains recorded and registration is **Paid/Confirmed** (or **Pending confirmation** per policy).
- Issue is logged/flagged for reconciliation.
- Ticket can be regenerated/re-linked once storage is repaired.

---

## AT-UC34-07 — Notification failure after success: ticket still accessible in-app (Extension 6a)
**Objective:** Ensure notification outages don’t block proof of registration.  
**Preconditions:** Simulate notification service failure; payment success and ticket stored.  
**Steps:**
1. Complete successful payment.
2. Trigger notification send failure.
3. Open **My Registration / Tickets**.
**Expected Results:**
- Ticket is still accessible in CMS.
- Registration remains confirmed.
- Notification failure is logged and may be retried.

---

## AT-UC34-08 — Accessing ticket without authentication redirects to login (Extension 7a)
**Objective:** Ensure tickets are protected when intended.  
**Preconditions:** Ticket exists; user logged out.  
**Steps:**
1. Attempt to access ticket URL directly while logged out.
2. Log in as `attendee1@example.com` when prompted.
**Expected Results:**
- System prompts for authentication.
- After login, user is redirected back to the ticket page.
- Ticket displays correctly.

---

## AT-UC34-09 — Duplicate confirmation requests do not create duplicate tickets (Extension 7b)
**Objective:** Ensure idempotency on refresh/retry.  
**Preconditions:** Successful payment completed.  
**Steps:**
1. On confirmation page, refresh multiple times and/or click “View receipt” repeatedly.
2. Check ticket list in **My Registration / Tickets**.
**Expected Results:**
- Only one ticket/receipt exists for the transaction.
- Transaction reference remains the same.
- No duplicate “Paid” records created for the same payment intent/order.

---

## AT-UC34-10 — Free registration: confirmation is generated and available (If applicable)
**Objective:** Ensure $0 registrations still provide proof.  
**Preconditions:** `CONF-19` has $0 ticket; attendee logged in.  
**Steps:**
1. Register for free ticket option and confirm.
2. View confirmation page and tickets list.
**Expected Results:**
- Confirmation artifact generated even without payment.
- Ticket/receipt indicates $0 amount (or “No charge”).
- Ticket is stored and retrievable later.

---

# Exit Criteria (Definition of Done for UC-34)
UC-34 is accepted when:
- Successful purchases generate and display a confirmation artifact (AT-UC34-01) and store it for later access (AT-UC34-02), and
- Notifications are sent when enabled and contain safe content (AT-UC34-03), and
- Failed payments do not generate tickets (AT-UC34-04), and
- Generation/storage/notification failures are handled without losing payment confirmation or creating false confirmations (AT-UC34-05 to AT-UC34-07), and
- Access control and idempotency are enforced (AT-UC34-08, AT-UC34-09), and
- Free registrations (if supported) still produce proof of registration (AT-UC34-10).
