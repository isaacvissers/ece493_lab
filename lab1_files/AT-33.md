# Acceptance Test Suite — UC-33 Pay via Credit Card for a Conference Ticket

## Scope
Validate that an attendee can pay via credit card to purchase a conference ticket, and that CMS:
- collects card details securely and validates inputs,
- integrates correctly with the payment gateway (approve/decline/error),
- confirms ticket/registration only after successful payment (or $0 bypass),
- prevents confirming purchases on cancel/decline/failure,
- handles 3-D Secure (if enabled),
- handles DB and notification failures safely,
- records a durable audit/payment status suitable for reconciliation.

Covers UC-33 extensions (5a, 6a, 7a, 7b, 7c, 8a, 10a, 2a).

## Assumptions / Notes
- Payment details should be handled via a PCI-compliant gateway UI (hosted fields/redirect). Tests validate observable behavior, not internal PCI implementation.
- “Success” means payment approved and registration/order status becomes **Paid/Confirmed**.
- “No confirmed ticket” means the user should not gain paid attendee privileges (if any) unless payment is successful (or $0).
- If the system uses async payment confirmation (webhooks), expected results should include “Pending” states accordingly.

---

## Test Data
- Users:
  - **Attendee**: `attendee1@example.com`
- Conference:
  - `CONF-16` registration open and requires payment for ticket `TICKET-PAID`
  - `CONF-17` provides a free ticket option `TICKET-FREE` ($0)
- Ticket pricing:
  - `TICKET-PAID`: $250
  - `TICKET-FREE`: $0
- Payment methods (gateway test fixtures):
  - **Approved card** (test)
  - **Declined card** (test)
  - **3-D Secure required card** (test, if supported)
- Failure simulations:
  - Payment gateway timeout/unavailable
  - Database write failure after gateway approval
  - Notification failure after success

---

# Test Cases

## AT-UC33-01 — Successful credit card payment confirms ticket (Happy Path)
**Objective:** Ensure payment approval leads to confirmed registration/ticket.  
**Preconditions:** `CONF-16` open; attendee logged in; `TICKET-PAID` selected.  
**Steps:**
1. Navigate to checkout for `TICKET-PAID`.
2. Choose **Pay via Credit Card**.
3. Enter approved test card details and submit.
**Expected Results:**
- Payment is approved by gateway.
- CMS marks order/registration as **Paid/Confirmed**.
- Confirmation page shows receipt/transaction reference.
- Ticket/registration appears as confirmed in attendee account.

---

## AT-UC33-02 — Attendee cancels before submitting payment; no ticket confirmed (Extension 5a)
**Objective:** Ensure cancellation does not create a confirmed purchase.  
**Preconditions:** Checkout open at credit card form.  
**Steps:**
1. Navigate to payment form.
2. Click **Cancel/Back** (or close payment window) before submitting.
3. Return to checkout/registration summary.
**Expected Results:**
- No payment is submitted to gateway.
- No confirmed ticket is created.
- User is returned to checkout with status **Unpaid/Not confirmed**.

---

## AT-UC33-03 — Invalid card input is blocked with field-level errors (Extension 6a)
**Objective:** Validate client/server input checks on card form.  
**Preconditions:** Payment form displayed.  
**Steps:**
1. Enter invalid card number format or leave required fields blank.
2. Attempt to submit.
**Expected Results:**
- Submission blocked.
- Required/invalid fields highlighted with actionable error messages.
- After correcting fields, submission is allowed.

---

## AT-UC33-04 — Issuer decline: payment not confirmed and clear message shown (Extension 7a)
**Objective:** Ensure declines do not confirm ticket.  
**Preconditions:** Checkout for `TICKET-PAID` ready.  
**Steps:**
1. Submit payment using a declined test card.
**Expected Results:**
- Gateway returns decline.
- CMS shows decline message (no sensitive codes exposed beyond user-safe reason if available).
- Registration/order remains **Unpaid/Not confirmed** (or **Payment failed**).
- User may retry with another card or method.

---

## AT-UC33-05 — Gateway error/unavailable: no confirmation; error + retry suggested (Extension 7b)
**Objective:** Ensure gateway errors fail safely.  
**Preconditions:** Simulate gateway outage/timeout.  
**Steps:**
1. Submit payment with valid card while gateway failure simulated.
**Expected Results:**
- CMS shows temporary error (e.g., “Payment service unavailable, try again”).
- No ticket is confirmed.
- Incident logged for admin review (if logging exists).

---

## AT-UC33-06 — 3-D Secure required: success path confirms ticket (Extension 7c, if enabled)
**Objective:** Validate step-up authentication flow.  
**Preconditions:** 3DS enabled; use test card that triggers 3DS.  
**Steps:**
1. Submit payment with 3DS-required test card.
2. Complete 3DS authentication successfully.
**Expected Results:**
- 3DS challenge shown and completed.
- Payment is approved.
- Ticket/registration becomes **Paid/Confirmed**.
- Receipt/confirmation displayed.

---

## AT-UC33-07 — 3-D Secure cancelled/failed: payment not confirmed (Extension 7c, failure branch)
**Objective:** Ensure failed authentication prevents confirmation.  
**Preconditions:** 3DS enabled; 3DS-required card used.  
**Steps:**
1. Submit payment and reach 3DS challenge.
2. Cancel or fail the authentication.
**Expected Results:**
- Payment fails / not authorized.
- CMS returns user to checkout with **Unpaid/Not confirmed** status.
- User can retry payment.

---

## AT-UC33-08 — DB write failure after gateway approval: no false confirmation; flagged for reconciliation (Extension 8a)
**Objective:** Ensure persistence failures don’t falsely show success.  
**Preconditions:** Simulate DB failure after receiving gateway approval.  
**Steps:**
1. Submit payment with an approved test card.
2. Trigger DB write failure during confirmation step.
3. Refresh account/ticket status page.
**Expected Results:**
- CMS shows error indicating confirmation could not be completed.
- System does NOT display a confirmed ticket unless stored successfully (or shows **Pending confirmation** if supported).
- Transaction is logged/flagged for reconciliation (admin-visible).
- User does not gain paid access until confirmation resolves (per policy).

---

## AT-UC33-09 — Notification failure after success does not roll back confirmation (Extension 10a)
**Objective:** Ensure confirmation stands even if email fails.  
**Preconditions:** Payment succeeds; simulate notification failure.  
**Steps:**
1. Complete successful payment.
2. Trigger notification (email/in-app) failure.
3. Check registration/ticket status in CMS.
**Expected Results:**
- Ticket remains **Paid/Confirmed**.
- Receipt/confirmation visible in CMS.
- Notification failure is logged and may be retried.
- User can still access ticket details in-app.

---

## AT-UC33-10 — $0 total bypasses payment and confirms registration (Extension 2a)
**Objective:** Ensure free tickets do not require card payment.  
**Preconditions:** `CONF-17` offers `TICKET-FREE` ($0); attendee logged in.  
**Steps:**
1. Select `TICKET-FREE` and proceed to checkout.
2. Observe payment step behavior.
**Expected Results:**
- System does not require credit card entry.
- Registration/ticket is confirmed immediately (**Confirmed**).
- Confirmation message/receipt is shown and optionally notified.

---

# Exit Criteria (Definition of Done for UC-33)
UC-33 is accepted when:
- Successful payments reliably create confirmed tickets with receipts (AT-UC33-01), and
- Cancel/invalid/decline/gateway-error flows do not confirm tickets (AT-UC33-02 to AT-UC33-05), and
- 3-D Secure flows behave correctly if enabled (AT-UC33-06, AT-UC33-07), and
- DB and notification failures are handled without corrupting user state (AT-UC33-08, AT-UC33-09), and
- $0 tickets bypass payment correctly (AT-UC33-10).
