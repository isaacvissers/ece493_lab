# UC-35 Scenario Narratives — Store Payment Confirmation and Record Registration Status

This document provides fully dressed scenario narratives for the **main success scenario** and **each alternative path (extension)** in **UC-35: Store payment confirmation and record registration status**.

---

## Main Success Scenario Narrative (Happy Path)

A conference attendee completes payment for registration through the CMS payment workflow. The payment gateway returns a successful payment confirmation event to the Conference Management System (CMS), either immediately as part of the checkout response or asynchronously via a secure webhook.

Upon receiving the confirmation, the CMS validates the event to ensure it is trustworthy and consistent. The system verifies the source authenticity (such as a signed webhook), checks that the amount and currency match the expected order total, and confirms that the transaction is linked to a known registration/order record in the database.

Next, the CMS ensures the confirmation has not already been processed by performing an idempotency check using the payment intent or transaction identifier. With validation complete, the system stores the payment confirmation details in the database, including the transaction reference, amount, currency, timestamp, and a reference to the attendee/order.

After persisting the payment record, the CMS updates the related registration/order status to **Paid/Confirmed**. The system then records an audit log entry indicating that the payment was confirmed and that the registration status changed. The updated status becomes immediately available to user-facing features, enabling the attendee to access proof of registration and any attendee privileges.

Optionally, the CMS triggers downstream processes such as generating a ticket/receipt and sending a confirmation notification, while maintaining the payment and status data as the authoritative record.

---

## Alternative Path Narrative — 2a: Confirmation Fails Validation (Wrong Amount/Currency, Invalid Signature, Unknown Source)

The CMS receives a message claiming that payment has succeeded. However, during validation the system detects that the confirmation is not trustworthy or not consistent with the expected order. This may occur because the signature verification fails, the amount/currency does not match the order total, or the event source is not recognized.

Because the event fails validation, the CMS rejects the confirmation and does not store it as a successful payment. The system does not update the registration/order status to **Paid/Confirmed**.

The CMS records a security/validation log entry describing the failure so administrators can investigate potential fraud, misconfiguration, or integration errors. The attendee remains unconfirmed until a valid payment confirmation is received and stored.

---

## Alternative Path Narrative — 2b: No Matching Order/Registration Found for the Confirmation

The CMS receives a valid-looking payment confirmation from the gateway, but the system cannot find any registration/order record that matches the payment intent or transaction identifier. This can happen if the order was deleted, never created properly, or the integration mapping is incorrect.

Instead of discarding the confirmation, the CMS stores the event in an “unmatched payments” queue or holding area for later reconciliation. The system logs the mismatch and, if supported, alerts administrators to investigate.

The CMS does not update any registration to **Paid/Confirmed** because there is no verified order to attach the payment to. Administrators reconcile the payment by locating the correct order or issuing refunds as needed.

---

## Alternative Path Narrative — 3a: Duplicate Confirmation Received (Webhook Retry or Refresh)

The CMS receives a payment confirmation event that it has already processed. This may occur because payment gateways retry webhooks when acknowledgements are delayed, or because the user refreshes a confirmation flow that triggers a duplicate processing attempt.

The system performs its idempotency check and detects that the transaction/payment intent identifier has already been recorded as successful. The CMS avoids creating duplicate payment records or applying duplicate status updates.

Instead, the CMS returns a success acknowledgement to the gateway to stop retries and keeps the registration status unchanged (already confirmed). The system may log that a duplicate confirmation was safely ignored for audit purposes.

---

## Alternative Path Narrative — 4a: Database Write Fails When Storing Payment Confirmation

The CMS receives a valid payment confirmation and successfully validates it. When the system attempts to store the payment confirmation record in the database, the database operation fails due to an outage or write error.

Because payment confirmation cannot be stored durably, the CMS does not mark the registration/order as **Paid/Confirmed**. The system logs the database failure and may retry the write or queue the operation for later (if supported). The affected order is flagged for reconciliation so administrators can ensure payment is not lost.

The attendee’s registration remains unconfirmed until the system successfully persists the payment confirmation and updates the registration status.

---

## Alternative Path Narrative — 5a: Payment Stored Successfully but Status Update Fails

The CMS validates the confirmation and successfully writes the payment confirmation record to the database. However, during the next step the system fails to update the linked registration/order status to **Paid/Confirmed**, such as due to a database constraint, temporary lock, or service failure.

The CMS logs the inconsistency and attempts to retry the status update. Because the payment record exists, the system can use it to restore consistency by eventually updating the registration status correctly. If automated retries fail, the system flags the order for reconciliation so administrators can correct the status manually.

The key outcome is that the system does not lose the payment record and ensures the registration status ultimately reflects the stored payment.

---

## Alternative Path Narrative — 6a: Audit Logging Fails

The CMS stores the payment confirmation and updates the registration status successfully. When the system attempts to write an audit log entry, the logging service fails or is unavailable.

The CMS proceeds with the main transactional work (payment and status) because those are the authoritative records. The system records the logging failure using a fallback mechanism or queues the audit event for later processing, depending on system design.

The attendee remains registered and confirmed; the only impact is reduced audit visibility until logging is restored.

---

## Alternative Path Narrative — 8a: Downstream Ticket Generation/Notification Fails

After the CMS stores payment confirmation and updates registration status, it triggers downstream actions such as generating a ticket/receipt and sending notifications.

A downstream component fails—for example, ticket generation errors or email delivery failures. The CMS logs the downstream failure and may retry later, but it does not roll back the stored payment confirmation or the confirmed registration status.

From the attendee’s perspective, registration remains confirmed; they may need to retrieve the ticket later from the CMS if immediate delivery fails. The system maintains correct core financial and registration state even when downstream processes have issues.
