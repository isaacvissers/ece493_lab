# Use Case UC-35: Store payment confirmation and record registration status

**Goal in Context**: The system stores payment confirmation so that registration status is recorded accurately for the attendee and conference.  
**Scope**: Conference Management System (CMS)  
**Level**: Subfunction (System)  
**Primary Actor**: System (CMS)  
**Secondary Actors**: Payment Gateway/Processor; CMS Database; Order/Registration Service; Audit/Logging Service; Notification Service (optional)  
**Trigger**: The CMS receives a successful payment confirmation event (gateway response, webhook, or internal payment completion) for a registration order.

## Success End Condition
* Payment confirmation is stored, the order/registration status is updated to **Paid/Confirmed**, and the record is retrievable for later verification/audit.

## Failed End Condition
* The system cannot persist payment confirmation or cannot update registration status due to data validation issues, duplicates, database errors, or mismatched order references; the system does not incorrectly mark a registration as confirmed without durable storage.

## Preconditions
* A registration/order exists in CMS for the attendee and conference.
* A payment attempt exists and is associated with the order (payment intent/transaction ID known).
* The system receives a payment confirmation from a trusted source (gateway response or signed webhook).
* The database and logging services are available (or the system can queue writes per policy).

## Main Success Scenario
1. The payment gateway returns (or the system receives) a **successful payment confirmation** for an order, including a transaction reference and amount.
2. The system validates the confirmation message (source authenticity, signature if applicable, expected amount/currency, and matching order/payment intent).
3. The system checks whether this confirmation has already been processed (idempotency check on transaction/payment intent ID).
4. The system writes the payment confirmation details to the database (transaction ID, amount, currency, timestamp, payer/attendee reference, status).
5. The system updates the related registration/order record to **Paid/Confirmed**.
6. The system records an audit log entry indicating the successful confirmation and status change.
7. The system makes the updated registration status available to user-facing workflows (e.g., ticket retrieval, attendee access).
8. *(Optional)* The system triggers downstream actions such as generating a ticket/receipt (UC-34) and sending notifications.

## Extensions
* **2a**: Confirmation fails validation (wrong amount/currency, invalid signature, unknown source)  
    * **2a1**: The system rejects the confirmation and does not update registration status.
    * **2a2**: The system logs the security/validation failure for investigation.
* **2b**: No matching order/registration found for the confirmation  
    * **2b1**: The system records the event in an “unmatched payments” queue/store.
    * **2b2**: The system logs the mismatch and alerts administrators if supported.
* **3a**: Duplicate confirmation received (webhook retry or user refresh)  
    * **3a1**: The system detects the transaction/payment intent has already been processed.
    * **3a2**: The system does not create duplicate payment records or duplicate status updates.
    * **3a3**: The system returns success/ack to stop repeated gateway retries.
* **4a**: Database write fails when storing payment confirmation  
    * **4a1**: The system does not mark registration as confirmed.
    * **4a2**: The system retries or queues the write (if supported) and logs the failure.
    * **4a3**: The system flags the order for reconciliation/admin review.
* **5a**: Payment stored successfully but status update fails  
    * **5a1**: The system logs the inconsistency and retries the status update.
    * **5a2**: The system ensures eventual consistency (payment exists; status corrected) or flags for reconciliation.
* **6a**: Audit logging fails  
    * **6a1**: The system proceeds with storing payment and updating status.
    * **6a2**: The system logs the logging failure via fallback mechanism (or queues audit event).
* **8a**: Downstream ticket generation/notification fails  
    * **8a1**: Payment and registration status remain correct.
    * **8a2**: The system logs downstream failures and may retry later.

## Related Information
* **Priority**: High (financial integrity)  
* **Frequency**: Medium–High (per paid registration)  
* **Open Issues**:  
  * Whether confirmations arrive synchronously (redirect response) or asynchronously (webhooks) is not specified.  
  * Required fields for payment confirmation storage (e.g., last 4 digits, payer name) are not specified.  
  * Data retention/audit requirements are not specified.
