# Acceptance Test Suite — UC-14 Enforce Reviewer Assignment Limit (Max 5 Papers)

## Scope
Validate that CMS enforces a **maximum of 5 assigned papers per reviewer** during referee assignment, including:
- allowing assignments when reviewer has < 5 assignments,
- blocking assignments when reviewer already has 5 assignments,
- failing safely when assignment counts cannot be determined,
- handling bulk assignment (some reviewers exceed limit),
- handling persistence failures after limit checks.

Covers UC-14 extensions (3a, 3b, 2a, 5a).

## Assumptions / Notes
- “Assigned papers” refers to active referee assignments that count toward workload. (If your implementation excludes withdrawn/completed, adjust setup and expectations.)
- The limit is enforced at assignment time and should prevent creating assignment records that exceed the cap.

---

## Test Data
- **Editor account**: `editor1@example.com` (role: Editor)
- **Reviewer under limit**: `under.limit@example.com` (currently assigned 4 papers)
- **Reviewer at limit**: `at.limit@example.com` (currently assigned 5 papers)
- **Reviewer lookup failure**: `lookup.fail@example.com` (simulate missing/DB error)
- **Eligible paper**: `PAPER-010` (status: Submitted/Eligible)
- **Additional eligible paper(s)**: `PAPER-011`, `PAPER-012` as needed for setup

---

# Test Cases

## AT-UC14-01 — Reviewer with fewer than 5 assignments can be assigned (Happy Path)
**Objective:** Ensure assignment succeeds when reviewer workload is below cap.  
**Preconditions:** Logged in as Editor; `under.limit@example.com` has exactly 4 assignments; `PAPER-010` eligible.  
**Steps:**
1. Open `PAPER-010` and select **Assign Referees**.
2. Enter `under.limit@example.com`.
3. Confirm assignment.
**Expected Results:**
- System checks assignment count and confirms < 5.
- Assignment is saved successfully.
- Confirmation shown.
- Reviewer now has 5 assignments (count updated accordingly).

---

## AT-UC14-02 — Reviewer at 5 assignments is blocked from additional assignment (Extension 3a)
**Objective:** Ensure limit is enforced at exactly 5.  
**Preconditions:** Logged in as Editor; `at.limit@example.com` has exactly 5 assignments; `PAPER-010` eligible.  
**Steps:**
1. Attempt to assign `at.limit@example.com` to `PAPER-010`.
**Expected Results:**
- System blocks the assignment.
- Error message states reviewer has reached max of 5 assigned papers.
- No assignment record is created.
- Reviewer assignment count remains 5.

---

## AT-UC14-03 — Reviewer at 4 can be assigned once but not twice
**Objective:** Validate boundary transition (4→5 allowed; next denied).  
**Preconditions:** Logged in as Editor; `under.limit@example.com` has exactly 4 assignments; papers `PAPER-010` and `PAPER-011` eligible.  
**Steps:**
1. Assign `under.limit@example.com` to `PAPER-010` (should reach 5).
2. Assign `under.limit@example.com` to `PAPER-011` (would become 6).
**Expected Results:**
- First assignment succeeds and count becomes 5.
- Second assignment is blocked with limit error.
- No assignment created for second attempt.

---

## AT-UC14-04 — Assignment count lookup failure blocks assignment (Extension 3b)
**Objective:** Ensure fail-safe behavior when count cannot be determined.  
**Preconditions:** Logged in as Editor; simulate lookup failure for `lookup.fail@example.com` (DB error or missing record).  
**Steps:**
1. Attempt to assign `lookup.fail@example.com` to an eligible paper.
**Expected Results:**
- System blocks the assignment.
- Error indicates assignment cannot be completed at this time.
- Failure is logged for administrator review (verify logs/monitoring event).
- No assignment record is created.

---

## AT-UC14-05 — Bulk assignment: some reviewers under limit, some at limit (Extension 2a)
**Objective:** Ensure mixed outcomes are handled clearly.  
**Preconditions:** Logged in as Editor; `under.limit@example.com` has 4; `at.limit@example.com` has 5; `PAPER-010` eligible.  
**Steps:**
1. Open **Assign Referees** for `PAPER-010`.
2. Enter both `under.limit@example.com` and `at.limit@example.com`.
3. Confirm.
**Expected Results (partial-apply approach):**
- System assigns `under.limit@example.com` successfully.
- System blocks `at.limit@example.com` due to limit.
- System displays summary of which were assigned vs rejected.
- Database contains only the allowed assignment.
**If all-or-nothing is implemented instead:**
- No assignments are saved and summary indicates the reason (one reviewer at limit).

---

## AT-UC14-06 — Database write failure after passing limit check does not create assignment (Extension 5a)
**Objective:** Ensure persistence failures do not create inconsistent state.  
**Preconditions:** Logged in as Editor; reviewer under limit; simulate DB write failure at save time.  
**Steps:**
1. Attempt to assign `under.limit@example.com` to an eligible paper.
2. Force DB write to fail after limit check.
**Expected Results:**
- System shows error indicating assignment could not be saved at this time.
- Failure is logged for administrator review.
- No assignment record is created.
- Reviewer assignment count remains unchanged.

---

## AT-UC14-07 — Concurrency: two editors assigning the same reviewer at near-same time (recommended)
**Objective:** Ensure limit is enforced under concurrent assignments.  
**Preconditions:** Reviewer has 4 assignments; two editor sessions available; two different eligible papers.  
**Steps:**
1. Editor A assigns reviewer to `PAPER-010` (would become 5).
2. At nearly the same time, Editor B assigns reviewer to `PAPER-011` (would become 6 if both succeed).
**Expected Results:**
- Only one of the two assignments succeeds.
- The other is blocked due to limit, or fails due to a concurrency/transaction guard.
- Final reviewer assignment count is 5, not 6.

---

# Exit Criteria (Definition of Done for UC-14)
UC-14 is accepted when:
- Assignments are allowed for reviewers below 5 and denied at 5 (AT-UC14-01 to AT-UC14-03), and
- Lookup failures fail safely (AT-UC14-04), and
- Bulk assignment handles mixed outcomes correctly (AT-UC14-05), and
- Persistence failures do not create inconsistent state (AT-UC14-06), and
- Concurrency does not allow exceeding the cap (AT-UC14-07).
